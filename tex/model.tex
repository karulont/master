\section{Integer programming model}
\TODO{Write introduction to the model}
Graph of vertices (nodes) of parking places and so forward.
\TODO{sets and iterators}
\TODO{Explanation of movement}
\begin{lemma}
    All feasible solutions to the integer model correspond to feasible
    movements of robots and all feasible movements of the robots correspond to
    feasible solutions to the$\ldots$
    \TODO{find good way to write this}
\end{lemma}
\begin{proof}
    This will become clear from the explanations $\ldots$
\end{proof}
\subsection{Variables}
The variables for the model are all binary, meaning their allowed values are from the set
$\{0,1\}$. There are three groups of variables:
\begin{enumerate}
    \item node status variables,
    \item edge occupied variables,
    \item decision variables.
\end{enumerate}
For every timestep, there is another layer of the variables. Meaning that if
we have $n$ variables for timestep $0$, and we have $t$ timesteps, then in total
there will be $tn$ variables in the model. In the variable indexing, the
timestep is the always the last index.

\subsubsection{Node status variables}
As specified in \autoref{sec:discrete problem}, there are many possible statuses
for parking spots. Node status variables are meant to encode the node status.
There is a variable for every combination of node, status and timestep. To be
more accurate, the group of node status variables is defined as
\begin{align}
    &\forall v \in \V \colon \forall w \in \W \colon \forall t \in \T \colon &
    \nstat_{v,w,t}
\end{align}

\subsubsection{Edge occupied variables}
There are variables for each directed edge between parking spots. When a robot
moves from vertex $u$ to vertex $v$ at timestep $t$, the edge variable
$\occu_{(u,v),t}$ is 1 to indicate that the edge is occupied. All edge variables
are defined as
\begin{align}
    &\forall e \in \E \colon \forall t \in \T \colon & \occu_{e,t}
\end{align}

\subsubsection{Decision variables}
This is the most important group of variables, because they represent the
decisions or actions that the model should find. The decision variables are
\begin{align}
    &\forall v \in \V \colon \forall w \in \Wmc \colon \forall d \in \D \colon
    \forall t \in \T \colon & \go_{v,w,d,t}\\
    &\forall v \in \V \colon \forall w \in \Wmc \colon \forall d \in \D \colon
    \forall t \in \T \colon & \cont_{v,w,d,t}\\
    &\forall v \in \V \colon \forall w \in \Wmc \colon \forall d \in \D \colon
    \forall t \in \T \colon & \stp_{v,w,d,t}\\
    &\forall v \in \V \colon \forall w \in \Wl \colon \forall t \in \T \colon &
    \lift_{v,w,d,t}\\
    &\forall v \in \V \colon \forall w \in \Wd \colon \forall t \in \T \colon &
    \drop_{v,w,d,t}
\end{align}
\TODO{Actually movement variables are there if edge $(v,\edg(v,d)) \in \E$.}
Decision variable is set to 1, if and only if that action is taken at the
specified node, with specified node status, and at specified timestep. For
movement variables: $\go_{v,w,d,t}$, $\cont_{v,w,d,t}$ and $\stp_{v,w,d,t}$
also the direction is specified. Decision variables already have
self-describing names, but to clarify, we explain them one-by-one
in~\autoref{tbl:decvars}.

\begin{table}[h]
    \center
    \begin{tabular}{| c | p{\textwidth - 2.6cm} |}
        \hline
        Variable & Meaning\\
        \hline
        $\go_{v,w,d,t}$ & At timestep $t$ on parking place $v$ with node status
        $w$, a robot starts to accelerate in direction $d$.\\ \hline
        $\cont_{v,w,d,t}$ & At timestep $t$ on parking place $v$ with node status
        $w$ a robot that is about to reach the neighbouring node in direction
        $d$, does not slow down and continues moving in direction $d$.\\ \hline
        $\stp_{v,w,d,t}$ & At timestep $t$ on parking place $v$ with node status
        $w$ a robot that is about to reach the neighbouring node in direction
        $d$, starts to de-accelerate to stop in the neighbouring node.\\ \hline
        $\lift_{v,w,t}$ & At timestep $t$ on parking place $v$ with node status
        $w$ a robot starts to lift a car.\\ \hline
        $\drop_{v,w,t}$ & At timestep $t$ on parking place $v$ with node status
        $w$ a robot starts to drop a car.\\
        \hline
    \end{tabular}
    \TODO{make this table nice}
    \caption{The table explaining the meaning of decision variables.}
    \label{tbl:decvars}
\end{table}

\subsection{Constraints}
\subsubsection{Helper functions and notation for constraints}
\label{sec:helpers}
The first helper function used is $\edg \colon \V \times \D \to \V$. Let
$\edg(v,d)$ denote the node that is in the direction $d$ from node $v$.

For directions we use $d + 1$ to denote the next direction from direction $d$ in
clockwise manner. Logically $d - 1$ is used to mark the next direction from $d$
in counterclockwise manner. For an example: $\Dn + 1 = \De$.

Some decisions take a specified amount of time. We want to disallow making such
decisions, which lead to actions that cannot be completed in the time frame of
the model. For this purpose we want to split $\T$ into two disjoint subsets.
Let $\T_i = \{ t | (t+i) \in \T\}$ and $\Tn_i = \T \setminus \T_i$.
\TODO{Add more meaningful stuff here}
\subsubsection{Simple constraints}
\label{sec:simple}
First constraint is to make sure that at every timestep each node has exactly
one status variable set.
\begin{align}
    &\forall v \in \V \colon \forall t \in \T \colon & \sum_{w \in \W}
    \nstat_{v,w,t} = 1
\end{align}
When a directed edge is used, its opposite cannot be used at the same time.
\begin{align}
    &\forall (u,v) \in \E \colon \forall t \in \T \colon & \occu_{(u,v),t} +
    \occu_{(v,u),t} \leq 1
\end{align}
No more than one moving thing can arrive at the same node at the same time.
\begin{align}
    &\forall v \in \V \colon \forall t \in \T \colon & \sum_{u \in \N(v)}
    \occu_{(u,v),t} \leq 1
\end{align}
\TODO{Maybe draw a figure showing the collision we avoid, using these constraints.}
We also want to forbid movements in the orthogonal directions.
\begin{equation}
    \begin{split}
        \forall v \in \V \colon \forall d \in \D \colon \forall t \in \T \colon
        \quad & \occu_{(\edg(v,d),v),t} \\ + \occu_{(v,\edg(v,d-1)),t} + &
        \occu_{(v,\edg(v,d+1)),t} \leq 1
    \end{split}
\end{equation}
Note that there are vertices such that they do not have an edge between them, or
they do not even have a neighbour in some directions. When that happens, the
invalid $\occu_{e,t}$ variables are not added to the sum.
Also it does not make sense to allow more than 1 decision at the same time, at
the same location.
\begin{equation}
    \begin{split}
        \forall v \in \V \colon \forall t \in \T \colon \quad & \sum_{d \in \D,
        w \in \Wmc}(\go_{v,w,d,t} + \stp_{v,w,d,t} + \cont_{v,w,d,t}) \\ + &
        \sum_{w \in \Wl} \lift_{v,w,t} + \sum_{w \in \Wd} \drop_{v,w,t} \leq 1
    \end{split}
\end{equation}

\subsubsection{Lifting and dropping constraints}
These constraints describe the lifting and dropping of cars. In fact they are
quite similar, they indeed are opposite actions. We will start with lifting
constraints. Instead of using $\T$, like we did in~\autoref{sec:simple}, we use
$\T_6$, because lifting takes 6 timesteps. First constraint type is to make sure
that the node status is correct, when a decision to lift is made.
\begin{align}
    &\forall v \in \V \colon \forall w \in \Wl \colon \forall t \in \T_6 \colon
    &\lift_{v,w,t} - \nstat_{v,w,t} \leq 0
\end{align}
While the lifting is in progress, we want the node status be fixed to
$\stat{lft}$.
\begin{align}
    &\forall v \in \V \colon \forall w \in \Wl \colon \forall t \in \T_6 \colon
    \forall i \in \{1,\ldots,5\} \colon &\lift_{v,w,t} -
    \nstat_{v,\stat{lft},t+i} \leq 0
\end{align}
And at the end of lifting, the node status should correspond to the lifted
thing. For that we have a simple helper function $f \colon \Wl \to \Wd$. It is
defined as: $f(\stat{rc}) = \stat{cr}$ and $\forall j \colon
f(\stat{rsc}_j) = \stat{scr}_j$. In words, the function $f$ determines the node
status after lifting. By using $f$ we can now give the set of constraints.
\begin{align}
    &\forall v \in \V \colon \forall w \in \Wl \colon \forall t \in \T_6 \colon
    &\lift_{v,w,t} - \nstat_{v,f(w),t+6} \leq 0
\end{align}
If the lifting cannot be completed, we just make sure that the decision is
never made.
\begin{align}
    &\forall v \in \V \colon \forall w \in \Wl \colon \forall t \in \Tn_6
    \colon &\lift_{v,w,t} = 0
\end{align}

For dropping we have almost the same constraints. First make sure that the node
status is correct, when decision is made.
\begin{align}
    &\forall v \in \V \colon \forall w \in \Wd \colon \forall t \in \T_2 \colon
    &\drop_{v,w,t} - \nstat_{v,w,t} \leq 0
\end{align}
Dropping takes less time than lifting, therefore the constraints for
intermediate node state are simpler than for lifting.
\begin{align}
    &\forall v \in \V \colon \forall w \in \Wd \colon \forall t \in \T_2 \colon
    &\drop_{v,w,t} - \nstat_{v,\stat{drp},t+1} \leq 0
\end{align}
To get the correct node status at the end of the drop, we can use the inverse
of the previous helper function $f$.
\begin{align}
    &\forall v \in \V \colon \forall w \in \Wd \colon \forall t \in \T_2 \colon
    &\drop_{v,w,t} - \nstat_{v,f^{-1}(w),t+2} \leq 0
\end{align}
As with lifting, if dropping action cannot be completed in the time frame of
the model, disable the decision.
\begin{align}
    &\forall v \in \V \colon \forall w \in \Wd \colon \forall t \in \Tn_2
    \colon &\drop_{v,w,t} = 0
\end{align}

\subsubsection{Moving constraints}
Depending on the direction and whether the robot is carrying a car, the
movement takes different number of timesteps. We introduce a new function $g
\colon \W \times \D \to \mathcal{N}$. Function $g(w,d)$ returns the number of
timesteps the movement of $w$ takes in direction $d$. 

Now movement constraints are tricky and constructing them needs some
abbreviations. The constraints in this section are for all combinations of $u
\in \V$, $w \in \Wmc$, $d \in \D$ and $t \in \T$.
\TODO{Fix this paragraph}

Now let $\td = g(w,d)$, and $\td' = \td-1$. When movement starts at time $t$,
the node status will change at time $t+\td$, and at time $t+\td'$ a decision
has to be made to continue moving in the same direction or stop. Let $v =
\edg(u,d)$ be the destination node and $e = (u,v)$ the edge that is used for
movement. Later we also need $u' = \edg(u,d+2)$\footnote{$d+2$ means the
opposite direction from $d$}, which is the node before $u$ and $v' =
\edg(v,d)$, which is the node after $v$. Also we need the set of node statuses
where the moving component $w$ could came from.
\begin{align}
    \uw = \{w_m \mid w_m \in \Wm \wedge \getMC(w_m) = w\}
\end{align}
When $e \notin \E$ we skip the constraints, because we do not have movement
variables for such a combination of starting vertex $u$ and direction $d$. Also
when $t+\td' \notin \T$ we disable the start of movement, because it cannot
continue.
\begin{align}
    &\IF{t+\td' \notin \T} &\go_{u,w,d,t} = 0
\end{align}
In addition to disabling go, we skip the rest of the constraints.

As with other decisions the first group of constraints make sure that node
status is correct at the time of the decision. In our case it has to be one of
the possible node statuses in $\uw$.
\begin{align}
    & \go_{u,w,d,t} - \sum_{w_u \in \uw} \nstat_{u,w_u,t} \leq 0
\end{align}
If we have the edge $(u',u) \in \E$, that means that an already moving object
could continue moving from $u'$ and is in other ways equivalent to a moving
object, that start accelerating from $u$. So we define an abbreviation.
\begin{align*}
    \goOrCont = \begin{cases}
        \go_{u,w,d,t} &\colon (u',u) \notin \E\\
        \go_{u,w,d,t} + \cont_{u',w,d,t} &\colon (u',u) \in \E
    \end{cases}
\end{align*}
and a constraint to make sure that those things do not happen at the same time.
\begin{align}
    \goOrCont \leq 1
\end{align}
When there is movement, it has to be continued or stopped.
\begin{align}
    \label{eq:goImpcont}
    \goOrCont - \stp_{u,w,d,t+\td'} - \cont_{u,w,d,t+\td'} = 0
\end{align}
Now again we have to check if movement can actually be completed. Earlier we
checked if $t+\td' \notin \T$ and skipped the rest of the constraints. However
now we check for $t+\td \not \T$. When that happens, we again disable the
movement.
\begin{align}
    &\IF{t+\td' \notin \T} &\go_{u,w,d,t} = 0
\end{align}
And skip the rest of the constraints. At first this seems redundant, but we
need to do it like this, because otherwise constraint~(\ref{eq:goImpcont}) would
not exist for $\cont$ and $\stp$ variables at the last timestep and no
constraint would stop them form obtaining value 1.

For the duration of movement the edge $e$ must be occupied and the node status
should remain same. However from $w$, we do not know the actual status,
therefore we have to go through all possibilities.
\begin{align}
    &\forall i \in \{0,\ldots,\td'\}\colon & \goOrCont - \occu_{e,t+i} \leq 0\\
    &\forall i \in \{1,\ldots,\td'\}\colon \forall w_u \in \uw\colon &
    \goOrCont + \nstat_{u,w_u,t} - \nstat_{u,uw,t+i} \leq 1
\end{align}
There is a simple check: if edge $(v,v') \notin \E$, we can disable continue at
$u$, because after reaching $v$ the robot cannot continue to $v'$. Also when
$t$ is so small, that a previous continue or go decision could not be made, we
disable both the stop and continue at time $t$.
\begin{align}
    &\IF{(v,v') \notin \E} &\cont_{u,w,d,t+\td'} = 0\\
    &\IF{t < \td'} &\cont_{u,w,d,t} = 0\\
    &\IF{t < \td'} &\stp_{u,w,d,t} = 0
\end{align}
\TODO{Maybe a figure showing robots moving together.}
Specifying node statuses for $u$ and $v$ after the movement would be simpler,
if things could not move together. However robots can move side-by-side, at the
same direction. For that reason we need to define additional set of node
statuses. And corresponding variables. When the robot moves away from $u$,
another thing can at the same time move into $u$. For that purpose, we define
the set of statuses, that can move behind $w$ as $\B$. At the same time another
moving object can disappear from $v$. Let $\A$ denote the set of things that
can move ahead of $w$.
\begin{align}
    &\B = \begin{cases}
        \Wmc &\colon w = \stat{r}\\
        \Wd &\colon w \neq \stat{r}
    \end{cases}
    &\A = \begin{cases}
        \{\stat{r}\} &\colon w = \stat{r}\\
        \Wmc &\colon w \neq \stat{r}
    \end{cases}
\end{align}
Now we construct the set of variables, which imply that some additional object
is coming into $u$.
\begin{align}
    \um = \begin{cases}
        0 &\colon (u',u) \notin \E\\
        \sum_{w_{u'} \in \B} \cont_{u',w_{u'},d,t+\td'} +
        \stp_{u',w_{u'},d,t+\td'} &\colon (u',u) \in \E
    \end{cases}
\end{align}
Now we can give the general constraint, which says something about $u$ status
at the end of movement. When $w$ moves away from $u$, it's status should be the
beginning status minus the $w$, or something else must have come into $u$.
\begin{align}
    \stp_{u,w,d,t+\td'} + \cont_{u,w,d,t+\td'} - \ul -\um \leq 0
\end{align}
The last constraint was a general one, that did not exactly specify the status
of $u$ after movement. To actually specify the status of $u$ after movement, we
need to go over all possible $w_u \in \uw$. When $u$ status is about to change
by continuing or stopping, and the $u$ status was $w_u$, the new status should
be $\remMC(w_u)$\footnote{$w_u$ without the moveable component} or something
else moved at the same time into $u$.
\begin{align}
    \begin{split}
        \forall w_u \in \uw\colon\quad &\stp_{u,w,d,t+\td'} + \cont_{u,w,d,t+\td'}
        - \um\\ &+ \nstat{u,w_u,t+\td'} -\nstat_{u,\remMC(w_u),t+\td'} \leq 1
    \end{split}
\end{align}
When there is the edge $(u\,u) \in \E$ only then the following group of
constraints is added. These make sure that if $w_b \in \B$ moved from $u'$ to $u$
the new status of $u$ will be what would be left in $u$ plus the thing that
moved in. There is one catch, what is left into $u$ is car and a robot carrying
a car cannot come to $u$.
\begin{align}
    \begin{split}
        \forall w_u \in \uw\colon &\forall w_b \in \B\colon \quad
        \cont_{u',w_b,d,t+\td'} + \stp_{u',w_b,d,t+\td'}\\
        &+\nstat_{u,w_u,t+\td'}
        -\nstat_{u,\addMC(\remMC(w_u), w_b),t+\td} \leq 1
    \end{split}
\end{align}

Similarly to $\um$ we construct the set of variables, which imply that something is
moving away from $v$.
\begin{align}
    \vl = \begin{cases}
        0 &\colon (v,v') \notin \E\\
        \sum_{w_v \in \A} \cont_{v,w_v,d,t+\td'} +
        \stp_{v,w_v,d,t+\td'} &\colon (v,v') \in \E
    \end{cases}
\end{align}
\subsubsection{Node status constraints}
\subsubsection{Edge occupied constraints}
\subsection{Initial status and objective}
\subsection{Size of the model}
